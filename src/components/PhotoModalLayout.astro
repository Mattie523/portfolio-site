---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';

interface Props {
	photo: any;
	photos: any[];
	backUrl: string;
	currentCategory?: 'headshots' | 'general';
	imageFolder: string;
}

const { photo, photos, backUrl, currentCategory, imageFolder } = Astro.props;
const currentPath = Astro.url.pathname;

// Import all images
const images = import.meta.glob('/src/assets/**/*', { eager: true });

// Find current photo index and prev/next
const currentIndex = photos.findIndex(p => p.slug === photo.slug);
const prevPhoto = currentIndex > 0 ? photos[currentIndex - 1] : null;
const nextPhoto = currentIndex < photos.length - 1 ? photos[currentIndex + 1] : null;

function getPrevUrl() {
	if (!prevPhoto) return null;
	return currentCategory ? `/photography/${currentCategory}/${prevPhoto.slug}` : `/photography/${prevPhoto.slug}`;
}

function getNextUrl() {
	if (!nextPhoto) return null;
	return currentCategory ? `/photography/${currentCategory}/${nextPhoto.slug}` : `/photography/${nextPhoto.slug}`;
}

const prevUrl = getPrevUrl();
const nextUrl = getNextUrl();
---

<Layout>
	<div class="max-w-7xl mx-auto p-4 md:p-8">
		<h2 class="text-3xl font-bold mb-6 dark:text-white">Photography</h2>

		<!-- Sub-navigation -->
		<nav class="mb-8">
			<ul class="flex gap-6 md:gap-8 text-base md:text-lg">
				<li><a href="/photography" class={`hover:text-sage-400 hover:underline decoration-sage-400 transition-colors ${currentPath === '/photography' || currentPath === '/photography/' ? 'text-sage-600 font-bold' : ''}`}>All</a></li>
				<li><a href="/photography/headshots" class={`hover:text-sage-400 hover:underline decoration-sage-400 transition-colors ${currentCategory === 'headshots' ? 'text-sage-600 font-bold' : ''}`}>Headshots</a></li>
				<li><a href="/photography/general" class={`hover:text-sage-400 hover:underline decoration-sage-400 transition-colors ${currentCategory === 'general' ? 'text-sage-600 font-bold' : ''}`}>General</a></li>
			</ul>
		</nav>

		<section class="isolate">
			<div class="columns-1 sm:columns-2 lg:columns-3 gap-6 space-y-6">
				{photos.map((p) => {
					const imagePath = `/src/assets/${imageFolder}/${p.filename}`;
					const imageModule = images[imagePath];
					return (
						<a href={currentCategory ? `/photography/${currentCategory}/${p.slug}` : `/photography/${p.slug}`} class="break-inside-avoid mb-6 overflow-hidden bg-gray-200 dark:bg-stone-800 cursor-pointer group min-h-[200px] block">
							{imageModule && (
								<Image
									src={imageModule.default}
									alt={p.alt}
									loading="lazy"
									widths={[400, 800, 1200]}
									sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
									class="w-full h-auto block transition-transform duration-500 ease-out group-hover:scale-105"
								/>
							)}
						</a>
					);
				})}
			</div>
		</section>
	</div>

	<!-- Photo Modal/Overlay -->
	<div id="modal-overlay" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4 md:p-8">
		<div id="modal-content" class="relative w-full h-full flex items-center justify-center pointer-events-none">
			<a href={backUrl} id="close-button" class="absolute -top-12 right-0 md:-top-14 md:-right-14 w-12 h-12 flex items-center justify-center text-white text-4xl hover:text-gray-300 active:text-gray-400 z-10 bg-black/50 rounded-full leading-none pointer-events-auto" aria-label="Close photo modal">&times;</a>

			{/* Navigation Arrows */}
			{prevUrl && (
				<a href={prevUrl} class="absolute left-2 md:left-8 w-12 h-12 md:w-16 md:h-16 flex items-center justify-center text-white text-4xl md:text-5xl hover:text-gray-300 active:text-gray-400 z-10 pointer-events-auto" aria-label="Previous photo">‹</a>
			)}
			{nextUrl && (
				<a href={nextUrl} class="absolute right-2 md:right-8 w-12 h-12 md:w-16 md:h-16 flex items-center justify-center text-white text-4xl md:text-5xl hover:text-gray-300 active:text-gray-400 z-10 pointer-events-auto" aria-label="Next photo">›</a>
			)}

			<div class="relative max-w-full max-h-full pointer-events-auto" transition:name={`photo-${photo.slug}`} transition:animate="morph">
				{(() => {
					const imagePath = `/src/assets/${imageFolder}/${photo.filename}`;
					const imageModule = images[imagePath];
					return imageModule && (
						<Image
							src={imageModule.default}
							alt={photo.alt}
							class="max-w-full max-h-[90vh] object-contain"
						/>
					);
				})()}
			</div>
		</div>
	</div>

	<script define:vars={{ backUrl, prevUrl, nextUrl }}>
		// Close modal on ESC key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				window.location.href = backUrl;
			} else if (e.key === 'ArrowLeft' && prevUrl) {
				window.location.href = prevUrl;
			} else if (e.key === 'ArrowRight' && nextUrl) {
				window.location.href = nextUrl;
			}
		});

		// Close modal when clicking background
		const overlay = document.getElementById('modal-overlay');

		overlay?.addEventListener('click', (e) => {
			if (e.target === overlay) {
				window.location.href = backUrl;
			}
		});
	</script>
</Layout>
